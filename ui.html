<!DOCTYPE html>
<html>
<head>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 12px;
      color: #333;
      padding: 16px;
      background: #fff;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .header h1 {
      font-size: 14px;
      font-weight: 600;
    }

    .header .icon {
      font-size: 18px;
    }

    .section {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #555;
    }

    input, select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      border-color: #4f46e5;
    }

    .api-key-row {
      display: flex;
      gap: 6px;
    }

    .api-key-row input {
      flex: 1;
    }

    .btn-save-key {
      padding: 8px 12px;
      background: #f3f4f6;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      white-space: nowrap;
    }

    .btn-save-key:hover {
      background: #e5e7eb;
    }

    .key-status {
      font-size: 11px;
      margin-top: 4px;
      color: #888;
    }

    .key-status.saved {
      color: #10b981;
    }

    .divider {
      height: 1px;
      background: #eee;
      margin: 16px 0;
    }

    .target-info {
      background: #f9fafb;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 16px;
      font-size: 11px;
      color: #666;
    }

    .target-info strong {
      color: #333;
    }

    .stats {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat {
      flex: 1;
      background: #f9fafb;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }

    .stat .num {
      font-size: 20px;
      font-weight: 700;
      color: #4f46e5;
    }

    .stat .lbl {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }

    .btn-primary {
      width: 100%;
      padding: 10px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #4338ca;
    }

    .btn-primary:disabled {
      background: #c7d2fe;
      cursor: not-allowed;
    }

    .btn-secondary {
      width: 100%;
      padding: 8px;
      background: #f3f4f6;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 8px;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .progress {
      margin-top: 12px;
      display: none;
    }

    .progress.show {
      display: block;
    }

    .progress-bar {
      height: 4px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #4f46e5;
      border-radius: 4px;
      transition: width 0.3s;
      width: 0%;
    }

    .progress-text {
      font-size: 11px;
      color: #888;
      margin-top: 6px;
      text-align: center;
    }

    .log {
      margin-top: 12px;
      max-height: 120px;
      overflow-y: auto;
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 6px;
      padding: 8px;
      font-family: monospace;
      font-size: 10px;
      display: none;
    }

    .log.show {
      display: block;
    }

    .log-entry {
      margin-bottom: 2px;
    }

    .log-entry.success { color: #4ade80; }
    .log-entry.error { color: #f87171; }
    .log-entry.info { color: #60a5fa; }
  </style>
</head>
<body>
  <div class="header">
    <span class="icon">RTL</span>
    <h1>Universal RTL Converter</h1>
  </div>

  <!-- API Key Section -->
  <div class="section">
    <label>Gemini API Key</label>
    <div class="api-key-row">
      <input type="password" id="apiKey" placeholder="Enter your Gemini API key..." />
      <button class="btn-save-key" id="saveKeyBtn">Save</button>
    </div>
    <div class="key-status" id="keyStatus">No key saved</div>
  </div>

  <!-- Settings -->
  <div class="section">
    <label>Target Language</label>
    <select id="targetLang">
      <option value="ar">Arabic (العربية)</option>
      <option value="he">Hebrew (עברית)</option>
      <option value="fa">Persian (فارسی)</option>
      <option value="ur">Urdu (اردو)</option>
    </select>
  </div>

  <div class="section">
    <label>Arabic Font</label>
    <select id="arabicFont">
      <option value="Tajawal">Tajawal</option>
      <option value="Cairo">Cairo</option>
      <option value="Noto Sans Arabic">Noto Sans Arabic</option>
      <option value="IBM Plex Sans Arabic">IBM Plex Sans Arabic</option>
    </select>
  </div>

  <div class="divider"></div>

  <!-- Scan Info -->
  <div class="target-info" id="targetInfo">
    Click <strong>Scan Page</strong> to analyze the current page.
  </div>

  <div class="stats" id="statsSection" style="display: none;">
    <div class="stat">
      <div class="num" id="textCount">0</div>
      <div class="lbl">Text Nodes</div>
    </div>
    <div class="stat">
      <div class="num" id="uniqueCount">0</div>
      <div class="lbl">Unique Strings</div>
    </div>
    <div class="stat">
      <div class="num" id="layoutCount">0</div>
      <div class="lbl">Layouts</div>
    </div>
  </div>

  <!-- Actions -->
  <button class="btn-secondary" id="scanBtn">Scan Current Page</button>
  <button class="btn-primary" id="convertBtn" disabled>Convert to RTL</button>

  <!-- Progress -->
  <div class="progress" id="progress">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText">Starting...</div>
  </div>

  <!-- Log -->
  <div class="log" id="log"></div>

  <script>
    const apiKeyInput = document.getElementById("apiKey");
    const saveKeyBtn = document.getElementById("saveKeyBtn");
    const keyStatus = document.getElementById("keyStatus");
    const targetLang = document.getElementById("targetLang");
    const arabicFont = document.getElementById("arabicFont");
    const targetInfo = document.getElementById("targetInfo");
    const statsSection = document.getElementById("statsSection");
    const textCount = document.getElementById("textCount");
    const uniqueCount = document.getElementById("uniqueCount");
    const layoutCount = document.getElementById("layoutCount");
    const scanBtn = document.getElementById("scanBtn");
    const convertBtn = document.getElementById("convertBtn");
    const progress = document.getElementById("progress");
    const progressFill = document.getElementById("progressFill");
    const progressText = document.getElementById("progressText");
    const logEl = document.getElementById("log");

    let scanData = null;

    // Save API key
    saveKeyBtn.onclick = () => {
      const key = apiKeyInput.value.trim();
      if (key) {
        parent.postMessage({ pluginMessage: { type: "save-key", key } }, "*");
        keyStatus.textContent = "Key saved!";
        keyStatus.className = "key-status saved";
      }
    };

    // Scan
    scanBtn.onclick = () => {
      scanBtn.disabled = true;
      scanBtn.textContent = "Scanning...";
      parent.postMessage({ pluginMessage: { type: "scan" } }, "*");
    };

    // Convert
    convertBtn.onclick = () => {
      const key = apiKeyInput.value.trim();
      if (!key) {
        keyStatus.textContent = "Please enter your Gemini API key first!";
        keyStatus.className = "key-status error";
        return;
      }
      if (!scanData) {
        alert("Please scan the page first.");
        return;
      }

      convertBtn.disabled = true;
      progress.classList.add("show");
      logEl.classList.add("show");

      parent.postMessage({
        pluginMessage: {
          type: "convert",
          apiKey: key,
          targetLang: targetLang.value,
          fontFamily: arabicFont.value,
          texts: scanData.texts,
        },
      }, "*");
    };

    function addLog(msg, type = "") {
      const entry = document.createElement("div");
      entry.className = "log-entry " + type;
      entry.textContent = msg;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    // Messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === "key-loaded") {
        if (msg.key) {
          apiKeyInput.value = msg.key;
          keyStatus.textContent = "Key loaded from storage";
          keyStatus.className = "key-status saved";
        }
      }

      if (msg.type === "scan-result") {
        scanData = msg;
        scanBtn.disabled = false;
        scanBtn.textContent = "Scan Current Page";
        targetInfo.innerHTML = `Page: <strong>${msg.pageName}</strong> — ${msg.frameCount} top-level frames found.`;
        statsSection.style.display = "flex";
        textCount.textContent = msg.totalTexts;
        uniqueCount.textContent = msg.uniqueTexts;
        layoutCount.textContent = msg.layoutCount;
        convertBtn.disabled = false;
      }

      if (msg.type === "progress") {
        progressFill.style.width = msg.percent + "%";
        progressText.textContent = msg.message;
        addLog(msg.message, "info");
      }

      if (msg.type === "done") {
        progressFill.style.width = "100%";
        progressText.textContent = "Conversion complete!";
        addLog(`Done! Translated: ${msg.translated}, Mirrored: ${msg.mirrored}`, "success");
        convertBtn.disabled = false;
        convertBtn.textContent = "Convert to RTL";
      }

      if (msg.type === "error") {
        progressText.textContent = "Error: " + msg.message;
        addLog("Error: " + msg.message, "error");
        convertBtn.disabled = false;
      }

      if (msg.type === "log") {
        addLog(msg.message, msg.logType || "");
      }
    };
  </script>
</body>
</html>
